# 培训中心管理系统

## 项目概述

1. **项目名称**  
   培训中心管理系统（train-center-system）

2. **项目背景**  
   该系统旨在为培训中心提供全方位的管理支持，涵盖机构管理、用户与角色权限控制、培训资源（视频、题库）管理、在线练习与自动判分、操作日志审计等核心功能，帮助培训中心实现数字化管理，规范业务流程，提升运营效率与培训质量。

3. **核心功能模块**
   - **机构管理**：支持机构全生命周期管理（新增、编辑、删除、状态切换），自动创建默认管理员，数据按机构隔离。
   - **用户与角色权限**：基于RBAC模型的用户管理（状态含禁用/正常/离职/锁定）、角色管理（关联菜单权限），支持系统级与机构级角色分离。
   - **培训资源管理**：培训视频分页查询（按机构筛选）、视频基础信息维护。
   - **在线练习**：题库管理、智能抽题、答题提交与自动判分、重新抽题功能。
   - **身份认证**：基于JWT的令牌认证，支持令牌黑名单与登录锁定机制，密码采用AES加密传输。
   - **操作日志**：记录用户操作（含账号、模块、类型、时间、结果等），支持IP地址识别与敏感信息过滤。


## 技术栈

| 类别         | 技术选型                                  | 说明                                  |
|--------------|-------------------------------------------|---------------------------------------|
| 后端框架     | Spring Boot 2.x、Spring Security          | 核心框架与安全控制                    |
| 数据访问     | MyBatis-Plus                              | ORM框架，简化CRUD操作                 |
| 数据库       | PostgreSQL                                | 主数据库，存储业务数据                |
| 缓存         | Redis 5.0+                                | 用于Token黑名单、权限缓存             |
| 认证机制     | JWT（JSON Web Token）                     | 无状态身份认证                        |
| 接口文档     | Swagger/OpenAPI 3.0                       | 自动生成API文档，支持接口调试         |
| 构建工具     | Maven 3.6+                                | 项目构建与依赖管理                    |
| 容器化       | Docker、Docker Compose                    | 环境一致性与快速部署                  |
| Web服务器    | Nginx                                     | 反向代理与静态资源管理                |
| 开发特性     | Lambda表达式、Stream API（Java 8+）       | 简化代码，提升开发效率                |


## 项目结构

### 核心目录结构
```
train-center-system/
├── src/main/java/com/train/
│   ├── controller/       # 控制器层（接口定义）
│   ├── service/          # 服务层（业务逻辑）
│   ├── mapper/           # 数据访问层（数据库操作）
│   ├── entity/           # 实体类（与数据库表映射）
│   ├── dto/              # 数据传输对象（接口参数/返回值）
│   ├── security/         # 安全模块（认证、权限）
│   ├── aspect/           # 切面模块（日志、权限拦截）
│   ├── exception/        # 异常处理（全局异常、业务异常）
│   └── util/             # 工具类（Excel、加密、转换等）
├── src/main/resources/   # 配置文件（application.yml、mapper.xml）
├── package/sql/          # 数据库脚本（初始化表结构、默认数据）
├── package/docker-compose/ # Docker配置文件
├── package/confing/nginx/  # Nginx配置文件
├── package/confing/redis   # Redis配置文件
└── src/test/             # 单元测试代码
└── api-docs.json         # API文档
├── api-docs.yaml         # API文档
└── README.md             # 项目说明

```


## 核心功能详解

### 1. 系统管理
#### 1.1 机构管理
- **功能描述**：支持机构分页查询（按名称、管理员账号/姓名模糊搜索）、新增、编辑、删除及状态切换（启用/禁用）。
- **关键特性**：
   - 新增机构时自动创建默认管理员（账号规则与初始密码见「使用说明」）。
   - 禁用机构后，该机构所有用户无法登录系统。
   - 仅系统超级管理员可删除机构，删除时级联清理关联用户、角色数据。
   - 提供`/train/sys/org/allEnable`接口，返回所有启用的机构列表（用于登录时选择机构）。

#### 1.2 用户管理
- **功能描述**：用户分页查询（按账号、用户名模糊搜索）、新增、编辑、删除、状态切换及密码重置。
- **用户状态**：0=禁用、1=正常、2=离职、3=锁定（连续错误登录触发）。
- **关键限制**：
   - 机构最后一名管理员不可删除，系统超级管理员不可编辑/删除。
   - 数据权限按用户所属机构隔离，普通用户仅能查看本机构数据。

#### 1.3 角色管理
- **功能描述**：角色分页查询、新增、编辑、删除、状态切换及权限分配。
- **权限控制**：通过菜单粒度控制权限，角色与菜单的关联关系采用「先删后加」的方式更新（`saveRoleMenu`方法）。
- **默认角色**（初始化脚本预设）：
   - `ROLE_ORG_ROLE_ADMIN`（机构管理员）：拥有机构内用户/角色管理权限。
   - `ROLE_ORG_ROLE_USER`（普通用户）：仅拥有业务操作权限。


### 2. 认证与授权
- **登录机制**：用户名格式为`账号@机构ID`（如`test@1001`），密码经AES加密传输。
- **JWT Token**：登录成功后生成Token，包含用户ID、账号、机构ID等信息；登出时加入黑名单，立即失效。
- **权限校验**：通过`@RequiresPermission`注解拦截接口，验证用户是否拥有对应权限（如`org:read`、`org:add`）。


### 3. 培训业务
#### 3.1 培训视频管理
- 支持按机构ID分页查询视频列表（`TrainVideoService.getVideoList`）。
- 视频资源存储于`/train-center-static/play/`路径，仅允许视频类型文件访问。

#### 3.2 在线练习
- **题库与抽题**：支持题库基础管理与智能抽题逻辑。
- **答题与判分**：答题提交后自动校验并判分，支持重新抽题功能。


### 4. 辅助功能
- **Excel处理**：支持复杂Excel导入导出（含子列表处理、统计功能），可通过`ExcelUtil`自定义显示/隐藏列。
- **操作日志**：记录操作账号、模块、类型、时间范围、结果等信息（`SysOperLogQuery`），用于审计追踪。


## 环境要求

| 依赖         | 版本要求               |
|--------------|------------------------|
| JDK          | 1.8 及以上             |
| Maven        | 3.6+                   |
| PostgreSQL   | 13+                    |
| Redis        | 5.0+                   |
| Docker       | 20.10+（容器化部署）   |
| Docker Compose | 2.0+（容器编排）      |


## 部署步骤

### 1. 源码部署
```bash
# 拉取代码
git clone [仓库地址]
cd train-center-system

# 配置环境（修改application.yml）
vi src/main/resources/application.yml
# 配置数据库连接、Redis地址等

# 构建项目
mvn clean package -Dmaven.test.skip=true

# 启动服务
java -jar target/train-center-system-1.0.0.jar
```

### 2. Docker部署
```bash
# 构建镜像
docker build -t train-center-system:1.0 .

# 启动容器（配合docker-compose）
docker-compose up -d
```

### 3. 初始化数据
执行`package/sql/init.sql`脚本初始化数据库表结构与默认数据（含超级管理员账号、默认角色）。


## 使用说明

1. **初始登录**
   - 超级管理员账号：`admin`，初始密码：`a123456`（加密后值：`h704/1LvkG555m+12IZcMLfgl6FqcJlRKvyWQWr3yvA=`）。
   - 登录后建议立即修改密码，密码需经AES加密后传输。

2. **接口访问**
   - 系统基础路径：`http://localhost:8080/train`
   - API文档地址：`http://localhost:8080/train/swagger-ui.html`
   - swagger-ap-docs: [api-docs.yaml](api-docs.yaml)   [api-docs.json](api-docs.json)

3. **权限说明**
   - 超级管理员拥有所有权限，可管理所有机构。
   - 机构管理员仅能操作本机构数据，权限由角色关联的菜单控制。


## 维护说明

1. **数据备份**  
   每日定时备份PostgreSQL数据库：
   ```bash
   mysqldump -u root -p train_center > backup_$(date +%Y%m%d).sql
   ```

2. **日志管理**
   - 日志路径：`logs/`目录（含接口访问日志、错误日志）。
   - 关键指标：登录失败率、权限校验失败次数（用于监控异常访问）。

3. **常见问题**
   - 登录失败：检查账号格式（`账号@机构ID`）、密码正确性、机构状态（是否启用）、用户状态（是否锁定）。
   - 权限不足：联系管理员分配对应角色权限（需关联正确菜单）。


## 项目进度

| 模块                | 状态         | 说明                     |
|-------------------|--------------|--------------------------|
| 系统管理（菜单/机构/用户/角色） | ✅ 已完成    | 含登录、权限控制         |
| 培训视频模块            | ✅ 已完成    | 基础数据与查询功能       |
| 在线练习模块            | ✅ 已完成    | 题库、抽题、判分功能     |
| 多中心质量评价模块         | 🔧 进行中    | 答题记录与评价查询开发中 |
 

## ✅ 项目进度概览
### 🟢 已完成模块（90%）
#### 项目基础搭建与配置
- B01-01 项目初始化
- B01-02 基础配置编写
- B01-03 全局通用组件开发
- B01-04 权限基础组件开发
#### 系统管理模块
- B2-00 登录接口开发
- B02-01 机构管理开发
- B02-02 角色管理开发
- B02-03 用户管理开发
- B02-04 操作日志开发
- B02-05 初始化数据导入
- B02-06 密码管理接口开发
- B02-07 登录锁定与解锁开发
#### 培训视频模块
- B03-01 视频基础数据开发

#### 在线练习模块
- B04-01 题库基础开发
- B04-02 抽题逻辑开发
- B04-03 答题提交与校验
- B04-04 自动判分逻辑开发
- B04-05 重新抽题开发
### ✅ 所有上述功能均已开发完成并通过验证。

### 🔧 待完成任务（进行中）
#### 多中心质量评价模块
- B05-1 答题记录存储开发 ⏳ 待开发
- B05-2 评价列表查询开发 ⏳ 待开发
- B05-3 答题详情查询开发（P1） ⏳ 待开发
- B06-01 联调、bug修复 ⏳ 待开发


