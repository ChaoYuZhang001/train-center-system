package com.train.service.impl;import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;import com.baomidou.mybatisplus.core.metadata.IPage;import com.baomidou.mybatisplus.extension.plugins.pagination.Page;import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;import com.train.constant.Constants;import com.train.entity.TrainVideo;import com.train.mapper.TrainVideoMapper;import com.train.service.TrainVideoService;import org.apache.commons.compress.utils.Sets;import org.springframework.beans.factory.annotation.Value;import org.springframework.stereotype.Service;import java.util.Set;/** * 培训视频服务实现类 */@Servicepublic class TrainVideoServiceImpl extends ServiceImpl<TrainVideoMapper, TrainVideo> implements TrainVideoService {    private static final String ORG_ID_FIELD = "org_id";    private static final String CREATE_TIME_FIELD = "create_time";    @Value("${train.video.coverUrlPrefix}")    private String coverUrlPrefix;    @Value("${train.video.playUrlPrefix}")    private String playUrlPrefix;    @Override    public IPage<TrainVideo> getVideoList(Page<TrainVideo> page, String orgId) {        // 验证orgId参数        if (orgId == null) {            throw new IllegalArgumentException("orgId cannot be null");        }        QueryWrapper<TrainVideo> queryWrapper = new QueryWrapper<>();        Set<String> orgIds = Sets.newHashSet();        orgIds.add(orgId);        orgIds.add(Constants.SYS_ORG_ID);        queryWrapper.in(ORG_ID_FIELD, orgIds);        // 按创建时间降序排列        queryWrapper.orderByDesc(CREATE_TIME_FIELD);        Page<TrainVideo> trainVideoPage = this.page(page, queryWrapper);        for (TrainVideo trainVideo : trainVideoPage.getRecords()) {            String coverUrl = trainVideo.getCoverUrl();            if (coverUrl != null) {                // 验证并处理URL前缀拼接，防止路径遍历                String safeCoverUrl = validateAndProcessUrl(coverUrl);                trainVideo.setCoverUrl(coverUrlPrefix + safeCoverUrl);            }            if (trainVideo.getPlayUrl() != null) {             trainVideo.setPlayUrl(playUrlPrefix + trainVideo.getPlayUrl());              }        }        return trainVideoPage;    }    @Override    public TrainVideo getById(Long videoId) {        // 调用父类方法避免递归        TrainVideo trainVideo = super.getById(videoId);        if (trainVideo != null) {            String coverUrl = trainVideo.getCoverUrl();            String playUrl = trainVideo.getPlayUrl();            if (coverUrl != null) {                // 验证并处理URL前缀拼接，防止路径遍历                String safeCoverUrl = validateAndProcessUrl(coverUrl);                trainVideo.setCoverUrl(coverUrlPrefix + safeCoverUrl);            }            if (playUrl != null) {                // 验证并处理URL前缀拼接，防止路径遍历                String safePlayUrl = validateAndProcessUrl(playUrl);                trainVideo.setPlayUrl(playUrlPrefix + safePlayUrl); // TODO 不需要播放权限 可不需要该接口            }            return trainVideo;        }        return null;    }    /**     * 验证并处理URL，防止路径遍历攻击     */    private String validateAndProcessUrl(String url) {        if (url == null) {            return null;        }        // 防止路径遍历攻击        if (url.contains("../") || url.contains("..\\") || url.startsWith("..")) {            throw new IllegalArgumentException("Invalid URL path: " + url);        }        return url;    }}